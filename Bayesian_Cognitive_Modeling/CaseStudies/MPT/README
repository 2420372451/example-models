In addition to the two implementations given in the Lee and Wagenmakers book, 
this folder contains three further implementationso of the hierarchical model.
These further implementations are more in line with the suggested way such 
models should be programmed in Stan using HMC. Some features of the original 
hierarchical implementation were specifically added to allow for a better 
convergence using Gibbs sampling such as implemented in JAGS or Bugs. These 
features do not help the model for the HMC sampler used by Stan and in fact, the 
model shows convergence issues with divergent transitions that can only be 
handeled by relatively strongly changing the stan samplers default settings. 
And even when removing the divergent transitions the final samples still show
problematic signs.

The new implementations avoid the Gibbs specific features. Specifically, these 
implementations do not use the Wishart as prior for the correlation matrix and 
do not use the parameter expansion, but can neverthless handle the divergent 
transitions. We include three implementations which follow the three 
recommendations given in the Stan manual (section 6.12. "Multivariate Priors for 
Hierarchical Models") for the Multivariate Regression Example of Gelman and 
Hill. All three of these have no parameter expansion parameters (xichat, ...). 
The other changes are: 

1. MPT_3_Stan.R:
Simply replaces the Wishart prior for the correlation with a correlation matrix 
Omega with LKJ prior and scaling vector tau. 
This model still shows some numerical problems and a few divergent transitions, 
even after constraining the prior for the scaling parameter tau to a half-normal 
with mean 0 and SD of 1 and increasing adapt_delta. Also, there are quite some 
correlation matrices that are not positive definite during estimation.

2. MPT_4_Stan.R:
Further replace the correlation matrix Omega with its Cholesky factor L_Omega 
and corresponding prior. Likewise, tau will be replaced by corresponding scaling
parameter sigma. Whereas this noticably increases the speed of optimization it 
does not really remove all the remaining numerical problems. We still have very
few divergent transitions. But the numerical problems with the correlation 
matrices are gone.

3. MPT_4_Stan.R:
This contains a further reparametrization of the multivariate normal 
distribution using a univariate distribtuion and basically solves the remaining 
issues. This reparametrization is extensively discussed in section 21.2. of the 
Stan manual. But it also is the same as given in section 6.12. 


For further details see the correspondoing thread on the Stan mailing list:
https://groups.google.com/forum/#!topic/stan-users/ZTiu_ij_bC8
